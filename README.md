#README

### Module Changelog for MeisterFit

## Installation

You should install it as a dev dependency `"meisterfit-changelog": "git+ssh://git@bitbucket.org:kingmuffin/meisterfit-changelog.git"`.
Now you can use the module as a CLI app `node ./node_modules/meisterfit-changelog [options] [params]`
See available options: `node ./node_modules/meisterfit-changelog -h`

For more convenient use add add the following to the `scripts` object in your `package.json`:

```
 "unreleased": "node ./node_modules/meisterfit-changelog -u",
 "release": "node ./node_modules/meisterfit-changelog -r"
```

## Integration with Jenkins

This module is focused on interacting with Jenkins. Connect the script that you need in Jenkinsfile.
To make the module work correctly, be sure to add the branch name as the first parameter.

```     
   stage('Changelog Unreleased') {
     when { branch 'dev' }
       steps {
         sh "docker run ${env.imageTag} npm run unreleased ${env.BRANCH_NAME}"
       }
   }
   
```
Now with every change on the outside branch of the "dev" Jenkins will launch the script.
To skip the launch of the script and skip the assembly, add the following to the jenkins file in the first step:

```
  stage('prepare') {
    steps {
      script {
        env.SKIP_CI = "false"
        result = sh (script: "git log -1 | grep '.*\\[skip ci\\].*'", returnStatus: true)
          if (result == 0) {
            env.SKIP_CI = 'true'
            error "'[skip ci]' found in git commit message. Aborting."
          }
      }
    }
  }

```  
 and in the end 
```
  post {
    always {
      script {
        if (env.SKIP_CI == "true") {
           currentBuild.result = 'NOT_BUILT'
        }
      }
    }
  }
```
Now, if you click "dev" on the remote from the local branch, just add [skip ci] to the last commit or in the name of the pull requests
 

## Principle of operation

1)  When the module is called with the -u option, the Commit script is run.
Which analyzes the last commit similar to: 

```
 Merged in MEIS-83-changelog (pull request #20)
                                                
 MEIS-83 changelog
```
from which it receives the number of the task, then makes a query to the Jira,
based on the received data, a commit of this format is built:

```
type: Issue Key

description
parent issue key (if type SubTask)
BREAKING CHANGES(if major version)

```

if you want the created commit called before the major version, add to the beginning of the comit which is analyzed:

`#major(a brief description that caused BREAKING CHANGES)`


Then, Unreleased script is run.
Analyzes the commits generated by the Commit script and, based on this data, creates CHANGELOG.md
or adds it to the category Unreleased (if it is already created)

Example:

-----------------------
# CHANGELOG

#### Unreleased  (2017-12-05)

##### Bug Fixes

*  Change for PDF (Download) ([MEIS-310](https://jira.kingmuffin.com/browse/MEIS-310))

##### New Features

*  Changelog ([MEIS-83](https://jira.kingmuffin.com/browse/MEIS-83))
*  Download the program in PDF format and print as an excel table ([MEIS-216](https://jira.kingmuffin.com/browse/MEIS-216))

##### Improvements

*  Social auth ([MEIS-194](https://jira.kingmuffin.com/browse/MEIS-194))   BREAKING CHANGES:test release

##### Sub Tasks

*  Update logo in icon and add to header (website) ([MEIS-236](https://jira.kingmuffin.com/browse/MEIS-236))  Parent:[MEIS-94](https://jira.kingmuffin.com/browse/MEIS-94)   BREAKING CHANGES:test release

----------------------

2)  When the module is called with the -r option, the Release script is run.
Analyzes the type of commits that are in the category unreleased, on the basis of this data it determines the current version number,
sets the tag, changes the version number in package.json and updates CHANGELOG.md

Example:

-----------------------
# CHANGELOG

##  v1.0.0 (2017-12-05)

##### Bug Fixes

*  Change for PDF (Download) ([MEIS-310](https://jira.kingmuffin.com/browse/MEIS-310))

##### New Features

*  Changelog ([MEIS-83](https://jira.kingmuffin.com/browse/MEIS-83))
*  Download the program in PDF format and print as an excel table ([MEIS-216](https://jira.kingmuffin.com/browse/MEIS-216))

##### Improvements

*  Social auth ([MEIS-194](https://jira.kingmuffin.com/browse/MEIS-194))   BREAKING CHANGES:test release

##### Sub Tasks

*  Update logo in icon and add to header (website) ([MEIS-236](https://jira.kingmuffin.com/browse/MEIS-236))  Parent:[MEIS-94](https://jira.kingmuffin.com/browse/MEIS-94)   BREAKING CHANGES:test release

----------------------

3)This module has an additional script that creates a customized for mobile platforms CHANGELOG, ie the section "What's new".
 To call it, you need to start the module with the -m option, and also pass the platform name as the first parameter.
 This additional script is oriented for use with FASTLANE,
 therefore it is not universal and has some features depending on the platform:

  3.1) For the IOS platform, the "What's New" section is created on the fly, so to use it you need to assign it to a variable.
  Add to Fastfile the following
  
    ```
    changelog = sh('node ../../node_modules/meisterfit-changelog -m ios')
    ```
  3.2)For the Android platform, the "What's new" section is created in a separate file,
  the file name is created automatically and corresponds to the current APK version code.
  Add to Fastfile the following
  
     ```
     sh('node ../../node_modules/meisterfit-changelog -m android')
    ```

In order for old changes not to fall into the new assembly of your application, 
you must create an app.json in the root of the project in which to put the following

```
{
  "whatsNewOld": {
    "android": [],
    "ios": []
  }
}
```
And in Jenkinsfile in the script "ungeleased" pass as the second parameter the word 'beta'
```
        stage('Changelog Unreleased') {
            when {
              branch 'dev'
            }
            steps {
              sh "docker run ${env.imageTag} npm run unreleased ${env.BRANCH_NAME} 'beta'"
            }
        }
```
"# changelog" 
